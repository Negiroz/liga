<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Liga SIGMA</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #f4f4f9; }
        .header-font { font-family: 'Oswald', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
         <header class="text-center mb-10 relative">
            <a href="admin.html" class="absolute left-0 top-1/2 -translate-y-1/2 bg-gray-200 text-gray-700 hover:bg-gray-300 font-semibold py-2 px-4 rounded-lg transition-colors">
                &larr; Volver a Admin
            </a>
            <h1 class="text-5xl font-bold text-blue-800 header-font">Gestión de Usuarios</h1>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <section class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold header-font mb-4">Usuarios del Sistema</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b-2 border-gray-200">
                            <tr>
                                <th class="p-2">Usuario</th>
                                <th class="p-2">Rol</th>
                                <th class="p-2">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="users-list-body"></tbody>
                    </table>
                </div>
            </section>

            <section class="bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold header-font mb-4">Crear Nuevo Usuario</h2>
                 <form id="create-user-form" class="space-y-4">
                     <div>
                         <label for="new-username" class="block font-semibold">Nombre de Usuario:</label>
                         <input type="text" id="new-username" class="w-full bg-gray-200 p-2 rounded border border-gray-300" required>
                     </div>
                     <div>
                         <label for="new-password" class="block font-semibold">Contraseña:</label>
                         <input type="password" id="new-password" class="w-full bg-gray-200 p-2 rounded border border-gray-300" required>
                     </div>
                     <div>
                         <label for="new-role" class="block font-semibold">Rol:</label>
                         <select id="new-role" class="w-full bg-gray-200 p-2 rounded border border-gray-300">
                             <option value="supervisor_closers">Supervisor de Closer</option>
                             <option value="supervisor_campo">Supervisor de Agentes Campo</option>
                             <option value="supervisor_atc">Supervisor de Atencion Cliente</option>
                             <option value="admin">Administrador</option>
                         </select>
                     </div>
                     <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md hover:bg-blue-700">Crear Usuario</button>
                 </form>
            </section>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('api/check_session.php');
                const session = await response.json();
                if (!session.loggedIn || session.user.role !== 'admin') { window.location.href = 'index.html'; }
            } catch (e) { window.location.href = 'index.html'; }

            const usersListBody = document.getElementById('users-list-body');
            const createUserForm = document.getElementById('create-user-form');
            const USERS_API = 'api/users.php';

            async function loadUsers() {
                try {
                    const response = await fetch(USERS_API);
                    const users = await response.json();
                    usersListBody.innerHTML = '';
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        row.className = "border-t";
                        row.innerHTML = `
                            <td class="p-2">${user.username}</td>
                            <td class="p-2">${user.role}</td>
                            <td class="p-2">
                                <button data-id="${user.id}" class="delete-user-btn text-red-500 hover:underline text-sm">Eliminar</button>
                            </td>
                        `;
                        usersListBody.appendChild(row);
                    });
                    document.querySelectorAll('.delete-user-btn').forEach(btn => btn.addEventListener('click', (e) => deleteUser(e.target.dataset.id)));
                } catch(e) { console.error('Error loading users:', e); }
            }

            async function deleteUser(id) {
                if (!confirm('¿Estás seguro de que quieres eliminar este usuario?')) return;
                try {
                    const response = await fetch(`${USERS_API}?id=${id}`, { method: 'DELETE' });
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    alert('Usuario eliminado');
                    loadUsers();
                } catch(e) { alert('Error: ' + e.message); }
            }

            createUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const newUser = {
                    username: document.getElementById('new-username').value,
                    password: document.getElementById('new-password').value,
                    role: document.getElementById('new-role').value
                };

                if(!newUser.username || !newUser.password) {
                    alert('El nombre de usuario y la contraseña no pueden estar vacíos.');
                    return;
                }

                try {
                    const response = await fetch(USERS_API, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json'},
                        body: JSON.stringify(newUser)
                    });
                    const result = await response.json();
                    if (result.error) throw new Error(result.error);
                    alert(result.message);
                    createUserForm.reset();
                    loadUsers();
                } catch(e) { alert('Error: ' + e.message); }
            });
            
            loadUsers();
        });
    </script>
</body>
</html>